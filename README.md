# Eidola Framework

> ä¸€ä¸ªé«˜æ€§èƒ½ã€ç”Ÿäº§çº§åˆ«çš„Goè¯­è¨€å¾®æœåŠ¡æ¡†æ¶ï¼Œä¸“ä¸ºç³»ç»Ÿå¼¹æ€§ã€å¯è§‚æµ‹æ€§å’Œå“è¶Šæ€§èƒ½è€Œè®¾è®¡

## ğŸš€ é¡¹ç›®æ¦‚è¿°

Eidolaæ˜¯ä¸€ä¸ªé¢å‘ç”Ÿäº§ç¯å¢ƒçš„Goå¾®æœåŠ¡æ¡†æ¶ï¼Œå®ƒæ•´åˆäº†ç°ä»£äº‘åŸç”Ÿåº”ç”¨æ‰€éœ€çš„å„ç§æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬æœåŠ¡æ³¨å†Œå‘ç°ã€è´Ÿè½½å‡è¡¡ã€é™æµç†”æ–­ã€å¯è§‚æµ‹æ€§å’Œå®‰å…¨è®¤è¯ç­‰ã€‚æ¡†æ¶åç§°"Eidola"æºè‡ªå¸Œè…Šè¯­ï¼Œæ„ä¸º"å¹»å½±"ï¼Œè±¡å¾ç€è½»é‡ã€é«˜æ•ˆä¸”å¯é çš„æœåŠ¡æ¶æ„ã€‚

### è®¾è®¡ç†å¿µ

- **é«˜æ€§èƒ½**ï¼šä»åº•å±‚è®¾è®¡ä¼˜åŒ–ï¼Œå‡å°‘GCå‹åŠ›ï¼Œæé«˜ååé‡
- **é«˜å¯é **ï¼šå†…ç½®å¤šç§å¼¹æ€§è®¾è®¡æ¨¡å¼ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨é«˜è´Ÿè½½å’Œæ•…éšœæƒ…å†µä¸‹çš„ç¨³å®šæ€§
- **å¯æ‰©å±•**ï¼šæ¨¡å—åŒ–æ¶æ„å’Œæ’ä»¶ç³»ç»Ÿï¼Œæ–¹ä¾¿å®šåˆ¶å’Œæ‰©å±•
- **å¼€å‘å‹å¥½**ï¼šç®€æ´APIå’Œå®Œå–„æ–‡æ¡£ï¼Œé™ä½ä½¿ç”¨é—¨æ§›

## âœ¨ æ ¸å¿ƒç‰¹æ€§

Eidolaæ¡†æ¶æä¾›äº†ä¸°å¯Œçš„åŠŸèƒ½ï¼Œå¸®åŠ©æ‚¨æ„å»ºå¯é ã€é«˜æ€§èƒ½çš„å¾®æœåŠ¡ï¼š

### æœåŠ¡æ²»ç†

- **æœåŠ¡æ³¨å†Œä¸å‘ç°**ï¼šæ”¯æŒetcdä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œè‡ªåŠ¨æœåŠ¡å¥åº·æ£€æŸ¥
- **è´Ÿè½½å‡è¡¡**ï¼šå†…ç½®å¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆè½®è¯¢ã€éšæœºã€æœ€å°‘æ´»è·ƒè¿æ¥ã€ä¸€è‡´æ€§å“ˆå¸Œç­‰ï¼‰
- **æœåŠ¡è·¯ç”±**ï¼šæ”¯æŒåŸºäºæ ‡ç­¾ã€æƒé‡çš„åŠ¨æ€è·¯ç”±ç­–ç•¥

### å¼¹æ€§è®¾è®¡

- **è‡ªé€‚åº”é™æµ**ï¼šæ ¹æ®ç³»ç»Ÿè´Ÿè½½åŠ¨æ€è°ƒæ•´é™æµé˜ˆå€¼ï¼Œæ™ºèƒ½ä¿æŠ¤ç³»ç»Ÿèµ„æº
- **è‡ªé€‚åº”ç†”æ–­**ï¼šè‡ªåŠ¨åˆ†æé”™è¯¯æ¨¡å¼å¹¶è°ƒæ•´ç†”æ–­å‚æ•°ï¼Œæé«˜ç³»ç»Ÿå¼¹æ€§
- **æ™ºèƒ½é‡è¯•**ï¼šåŸºäºé€€é¿ç®—æ³•çš„é‡è¯•æœºåˆ¶ï¼Œé¿å…é›ªå´©æ•ˆåº”
- **è¿æ¥æ± ç®¡ç†**ï¼šä¼˜åŒ–çš„è¿æ¥æ± å®ç°ï¼Œå‡å°‘è¿æ¥å»ºç«‹å¼€é”€

### æ€§èƒ½ä¼˜åŒ–

- **æ‰¹å¤„ç†è¯·æ±‚åˆå¹¶**ï¼šæ™ºèƒ½æ‰¹å¤„ç†æœºåˆ¶ï¼Œå‡å°‘ç½‘ç»œå¾€è¿”ï¼Œä¼˜åŒ–ç³»ç»Ÿååé‡
- **å†…å­˜å¯¹è±¡æ± **ï¼šç±»å‹å®‰å…¨çš„å¯¹è±¡æ± å®ç°ï¼Œå‡å°‘GCå‹åŠ›ï¼Œæå‡æ€§èƒ½
- **æ•°æ®å‹ç¼©**ï¼šå¤šç§å‹ç¼©ç®—æ³•æ”¯æŒï¼Œä¼˜åŒ–ç½‘ç»œä¼ è¾“æ•ˆç‡

### å¯è§‚æµ‹æ€§

- **åˆ†å¸ƒå¼è¿½è¸ª**ï¼šåŸºäºOpenTelemetryçš„å…¨é“¾è·¯è¿½è¸ªå®ç°
- **æŒ‡æ ‡ç›‘æ§**ï¼šä¸Prometheusé›†æˆçš„åº¦é‡æŒ‡æ ‡æ”¶é›†
- **ç»“æ„åŒ–æ—¥å¿—**ï¼šç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼å’Œçº§åˆ«æ§åˆ¶

### å®‰å…¨ç‰¹æ€§

- **å¤šå±‚è®¤è¯æˆæƒ**ï¼šæ”¯æŒJWTã€TLSå’ŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)
- **æ•æ„Ÿå­—æ®µåŠ å¯†**ï¼šå­—æ®µçº§åˆ«çš„åŠ å¯†åŠŸèƒ½ï¼Œä¿æŠ¤æ•æ„Ÿæ•°æ®å®‰å…¨
- **å¢å¼ºé”™è¯¯å¤„ç†**ï¼šç»“æ„åŒ–é”™è¯¯ä¿¡æ¯ï¼Œæ”¯æŒé”™è¯¯åˆ†ç±»ã€ä¸¥é‡ç¨‹åº¦å’Œæ¢å¤ç­–ç•¥

## ğŸ”¨ å¿«é€Ÿå¼€å§‹

### å®‰è£…

```bash
go get github.com/dormoron/eidola
```

### åˆ›å»ºæœåŠ¡ç«¯

```go
package main

import (
    "log"
    
    "github.com/dormoron/eidola"
    "github.com/dormoron/eidola/registry/etcd"
)

func main() {
    // åˆ›å»ºetcdæ³¨å†Œä¸­å¿ƒ
    registry, err := etcd.NewRegistry(etcd.Config{
        Endpoints: []string{"localhost:2379"},
    })
    if err != nil {
        log.Fatalf("åˆ›å»ºæ³¨å†Œä¸­å¿ƒå¤±è´¥: %v", err)
    }
    
    // åˆ›å»ºæœåŠ¡å™¨
    server, err := eidola.NewServer("user-service",
        eidola.ServerWithRegistry(registry),
        eidola.ServerWithGracefulStop(true),
    )
    if err != nil {
        log.Fatalf("åˆ›å»ºæœåŠ¡å™¨å¤±è´¥: %v", err)
    }
    
    // æ³¨å†ŒæœåŠ¡å®ç°
    // pb.RegisterUserServiceServer(server.Server, &UserService{})
    
    // å¯åŠ¨æœåŠ¡å™¨
    if err := server.Start(":50051"); err != nil {
        log.Fatalf("å¯åŠ¨æœåŠ¡å™¨å¤±è´¥: %v", err)
    }
}
```

### åˆ›å»ºå®¢æˆ·ç«¯

```go
package main

import (
    "context"
    "log"
    "time"
    
    "github.com/dormoron/eidola"
    "github.com/dormoron/eidola/internal/circuitbreaker"
    "github.com/dormoron/eidola/registry/etcd"
)

func main() {
    // åˆ›å»ºetcdæ³¨å†Œä¸­å¿ƒ
    registry, err := etcd.NewRegistry(etcd.Config{
        Endpoints: []string{"localhost:2379"},
    })
    if err != nil {
        log.Fatalf("åˆ›å»ºæ³¨å†Œä¸­å¿ƒå¤±è´¥: %v", err)
    }
    
    // åˆ›å»ºå®¢æˆ·ç«¯
    client, err := eidola.NewClient(
        eidola.ClientWithResolver(registry, 10*time.Second),
        eidola.ClientWithCircuitBreaker(circuitbreaker.DefaultOptions()),
        eidola.ClientInsecure(),
    )
    if err != nil {
        log.Fatalf("åˆ›å»ºå®¢æˆ·ç«¯å¤±è´¥: %v", err)
    }
    
    // è¿æ¥åˆ°æœåŠ¡
    conn, err := client.Dial(context.Background(), "user-service")
    if err != nil {
        log.Fatalf("è¿æ¥æœåŠ¡å¤±è´¥: %v", err)
    }
    defer conn.Close()
    
    // åˆ›å»ºæœåŠ¡å®¢æˆ·ç«¯
    // userClient := pb.NewUserServiceClient(conn)
    
    // è°ƒç”¨æœåŠ¡æ–¹æ³•
    // ...
}
```

## ğŸ“š æ ¸å¿ƒç»„ä»¶è¯¦è§£

### è‡ªé€‚åº”é™æµ

åŸºäºç³»ç»Ÿè´Ÿè½½å’Œå“åº”æ—¶é—´åŠ¨æ€è°ƒæ•´é™æµé˜ˆå€¼ï¼Œæ¯”ä¼ ç»Ÿå›ºå®šé˜ˆå€¼é™æµå™¨æ›´èƒ½é€‚åº”å˜åŒ–çš„ç¯å¢ƒã€‚

```go
// åˆ›å»ºè‡ªé€‚åº”é™æµå™¨
limiter := ratelimit.NewAdaptiveLimiter(ratelimit.AdaptiveLimiterOptions{
    InitialRate: 100,               // åˆå§‹QPS
    MinRate:     10,                // æœ€ä½QPS
    MaxRate:     1000,              // æœ€é«˜QPS
    HighLoadThreshold: 0.75,        // 75%CPUä½¿ç”¨ç‡è§†ä¸ºé«˜è´Ÿè½½
    LowLoadThreshold:  0.50,        // 50%CPUä½¿ç”¨ç‡è§†ä¸ºä½è´Ÿè½½
    ResponseTimeThreshold: 100 * time.Millisecond,
})

// é™æµæ£€æŸ¥
if err := limiter.AllowWithContext(ctx); err != nil {
    return nil, status.Errorf(codes.ResourceExhausted, "rate limit exceeded: %v", err)
}
```

### å¢å¼ºé”™è¯¯å¤„ç†

ç»“æ„åŒ–é”™è¯¯ä¿¡æ¯ï¼Œæ”¯æŒé”™è¯¯åˆ†ç±»ã€ä¸¥é‡ç¨‹åº¦å’Œæ¢å¤ç­–ç•¥ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥å’Œç³»ç»Ÿç›‘æ§ã€‚

```go
// åˆ›å»ºå¢å¼ºé”™è¯¯
err := errs.NewEnhancedError(
    "USER_NOT_FOUND",               // é”™è¯¯ä»£ç 
    "ç”¨æˆ·ä¸å­˜åœ¨",                     // é”™è¯¯æ¶ˆæ¯
    errs.SeverityError,             // é”™è¯¯ä¸¥é‡ç¨‹åº¦
    errs.CategoryBusiness,          // é”™è¯¯ç±»åˆ«
)

// æ·»åŠ å…ƒæ•°æ®
err.WithMetadata("user_id", "12345")
   .WithRecoveryStrategy(errs.RecoveryRetry)

// ä»ç°æœ‰é”™è¯¯åˆ›å»ºå¢å¼ºé”™è¯¯
if dbErr != nil {
    enhancedErr := errs.FromError(
        dbErr, 
        "DB_ERROR", 
        errs.SeverityCritical, 
        errs.CategoryDatabase,
    )
    return nil, enhancedErr
}
```

### æ‰¹å¤„ç†è¯·æ±‚åˆå¹¶

æ™ºèƒ½åˆå¹¶å¤šä¸ªè¯·æ±‚ä¸ºä¸€ä¸ªæ‰¹å¤„ç†æ“ä½œï¼Œå‡å°‘ç½‘ç»œå¾€è¿”ï¼Œä¼˜åŒ–ç³»ç»Ÿååé‡ã€‚

```go
// åˆ›å»ºæ‰¹å¤„ç†å™¨
processor := func(ctx context.Context, batchReq interface{}) (interface{}, error) {
    requests := batchReq.([]interface{})
    // æ‰¹é‡å¤„ç†é€»è¾‘
    return results, nil
}

batcher := batch.NewAdaptiveBatcher(processor, batch.AdaptiveBatchOptions{
    MaxBatchSize: 100,              // æœ€å¤§æ‰¹å¤„ç†å¤§å°
    MaxLatency:   50 * time.Millisecond, // æœ€å¤§ç­‰å¾…æ—¶é—´
})

// å¤„ç†è¯·æ±‚
result, err := batcher.Process(ctx, request)
```

### å­—æ®µçº§åŠ å¯†

æä¾›å­—æ®µçº§åˆ«çš„åŠ å¯†åŠŸèƒ½ï¼Œä¿æŠ¤æ•æ„Ÿæ•°æ®å®‰å…¨ï¼Œæ”¯æŒè‡ªåŠ¨åŠ å¯†å’Œæ©ç å¤„ç†ã€‚

```go
// åˆ›å»ºå­—æ®µåŠ å¯†å™¨
encryptor, _ := security.NewFieldEncryptor([]byte("encryption-key-12345678901234"))

// æ³¨å†Œéœ€è¦åŠ å¯†çš„ç±»å‹å’Œå­—æ®µ
encryptor.RegisterType(&UserInfo{}, []string{
    "Password",                    // å®Œå…¨åŠ å¯†
    "CreditCard:mask",             // æ©ç å¤„ç†
})

// åŠ å¯†æ•°æ®
user := &UserInfo{
    Name:       "å¼ ä¸‰",
    Password:   "secret123",
    CreditCard: "1234-5678-9012-3456",
}
encryptor.Encrypt(user)  // Passwordè¢«åŠ å¯†ï¼ŒCreditCardè¢«æ©ç å¤„ç†ä¸º"****-****-****-3456"
```

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
eidola/
â”œâ”€â”€ auth/             # è®¤è¯ä¸æˆæƒæ¨¡å—
â”‚   â”œâ”€â”€ authorization/ # æˆæƒç›¸å…³å®ç°
â”‚   â”œâ”€â”€ mfa/          # å¤šå› ç´ è®¤è¯æ”¯æŒ
â”‚   â””â”€â”€ tls/          # TLSå®‰å…¨é…ç½®
â”œâ”€â”€ cluster/          # é›†ç¾¤ç®¡ç†
â”œâ”€â”€ examples/         # ç¤ºä¾‹ä»£ç 
â”œâ”€â”€ internal/         # å†…éƒ¨å®ç°
â”‚   â”œâ”€â”€ batch/        # è¯·æ±‚æ‰¹å¤„ç†
â”‚   â”œâ”€â”€ circuitbreaker/ # æ–­è·¯å™¨å®ç°
â”‚   â”œâ”€â”€ compression/  # æ•°æ®å‹ç¼©
â”‚   â”œâ”€â”€ connpool/     # è¿æ¥æ± 
â”‚   â”œâ”€â”€ errs/         # å¢å¼ºé”™è¯¯å¤„ç†
â”‚   â”œâ”€â”€ mempool/      # å†…å­˜å¯¹è±¡æ± 
â”‚   â”œâ”€â”€ retry/        # é‡è¯•ç­–ç•¥
â”‚   â”œâ”€â”€ security/     # å®‰å…¨ç›¸å…³
â”‚   â”œâ”€â”€ serialization/ # åºåˆ—åŒ–
â”‚   â””â”€â”€ stream/       # æµå¤„ç†
â”œâ”€â”€ loadbalance/      # è´Ÿè½½å‡è¡¡
â”‚   â”œâ”€â”€ fastest/      # æœ€å¿«å“åº”
â”‚   â”œâ”€â”€ hash/         # ä¸€è‡´æ€§å“ˆå¸Œ
â”‚   â”œâ”€â”€ leastactive/  # æœ€å°‘æ´»è·ƒè¿æ¥
â”‚   â”œâ”€â”€ random/       # éšæœºé€‰æ‹©
â”‚   â””â”€â”€ round_robin/  # è½®è¯¢
â”œâ”€â”€ observability/    # å¯è§‚æµ‹æ€§
â”‚   â”œâ”€â”€ logging/      # æ—¥å¿—
â”‚   â”œâ”€â”€ metrics/      # æŒ‡æ ‡
â”‚   â””â”€â”€ opentelemetry/ # åˆ†å¸ƒå¼è¿½è¸ª
â”œâ”€â”€ plugin/           # æ’ä»¶ç³»ç»Ÿ
â”œâ”€â”€ ratelimit/        # é™æµå®ç°
â”‚   â””â”€â”€ lua/          # Redis Luaè„šæœ¬
â”œâ”€â”€ registry/         # æœåŠ¡æ³¨å†Œ
â”‚   â””â”€â”€ etcd/         # Etcdå®ç°
â”œâ”€â”€ client.go         # å®¢æˆ·ç«¯å®ç°
â”œâ”€â”€ resolver.go       # æœåŠ¡è§£æå™¨
â””â”€â”€ server.go         # æœåŠ¡ç«¯å®ç°
```

## ğŸ” å®‰å…¨æ€§å»ºè®®

1. **ä¼ è¾“å®‰å…¨**
   - ç”Ÿäº§ç¯å¢ƒå§‹ç»ˆå¯ç”¨TLSåŠ å¯†
   - å®šæœŸè½®æ¢è¯ä¹¦
   - é…ç½®é€‚å½“çš„å¯†ç å¥—ä»¶

2. **è®¤è¯ä¸æˆæƒ**
   - å¯¹æ•æ„Ÿæ“ä½œå®æ–½å¤šå› ç´ è®¤è¯
   - ä½¿ç”¨ç»†ç²’åº¦çš„RBACæƒé™æ§åˆ¶
   - æ•æ„Ÿæ•°æ®å§‹ç»ˆä½¿ç”¨å­—æ®µçº§åŠ å¯†

3. **é™æµä¸ä¿æŠ¤**
   - ä¸ºæ‰€æœ‰å…¬å¼€APIé…ç½®é€‚å½“çš„é™æµ
   - ä½¿ç”¨è‡ªé€‚åº”é™æµåº”å¯¹æµé‡æ³¢åŠ¨
   - å¯¹å…³é”®èµ„æºå®æ–½ç†”æ–­ä¿æŠ¤

## ğŸ“ˆ æ€§èƒ½è°ƒä¼˜

1. **è¿æ¥ç®¡ç†**
   - æ ¹æ®æœåŠ¡è§„æ¨¡è°ƒæ•´è¿æ¥æ± å¤§å°
   - å¯ç”¨è¿æ¥ç©ºé—²è¶…æ—¶ï¼Œé¿å…èµ„æºæµªè´¹
   - ä½¿ç”¨è‡ªé€‚åº”è¿æ¥æ± åº”å¯¹è´Ÿè½½å˜åŒ–

2. **è¯·æ±‚å¤„ç†**
   - å¯ç”¨æ‰¹å¤„ç†åˆå¹¶ç›¸ä¼¼è¯·æ±‚
   - ä½¿ç”¨å†…å­˜å¯¹è±¡æ± å‡å°‘åƒåœ¾å›æ”¶å‹åŠ›
   - å¯¹å¤§å‹è´Ÿè½½å¯ç”¨å‹ç¼©

3. **èµ„æºé™åˆ¶**
   - è®¾ç½®é€‚å½“çš„å¹¶å‘æµé™åˆ¶
   - é…ç½®æ¶ˆæ¯å¤§å°ä¸Šé™é˜²æ­¢èµ„æºè€—å°½
   - å®æ–½è¯·æ±‚è¶…æ—¶é¿å…é•¿æ—¶é—´é˜»å¡

## ğŸ” å¯è§‚æµ‹æ€§

1. **åº¦é‡æŒ‡æ ‡**
   - æ”¶é›†æœåŠ¡çº§åˆ«æŒ‡æ ‡ (è¯·æ±‚ç‡ã€é”™è¯¯ç‡ã€å»¶è¿Ÿ)
   - ç›‘æ§ç³»ç»Ÿèµ„æº (CPUã€å†…å­˜ã€ç½‘ç»œ)
   - è®¾ç½®é€‚å½“çš„å‘Šè­¦é˜ˆå€¼

2. **åˆ†å¸ƒå¼è¿½è¸ª**
   - å¯ç”¨OpenTelemetryè¿½è¸ªæ‰€æœ‰æœåŠ¡é—´è°ƒç”¨
   - å¯¹å…³é”®è·¯å¾„è¿›è¡Œè¯¦ç»†è¿½è¸ª
   - åˆ†ææ€§èƒ½ç“¶é¢ˆå’Œå¼‚å¸¸è·¯å¾„

3. **æ—¥å¿—ç®¡ç†**
   - ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—æ ¼å¼
   - é›†ä¸­æ”¶é›†å’Œåˆ†ææ—¥å¿—
   - å®æ–½æ—¥å¿—çº§åˆ«æ§åˆ¶å‡å°‘å™ªéŸ³

## ğŸ¤ è´¡çŒ®æŒ‡å—

æˆ‘ä»¬æ¬¢è¿å„ç§å½¢å¼çš„è´¡çŒ®ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š

- æäº¤é—®é¢˜å’ŒåŠŸèƒ½è¯·æ±‚
- æ”¹è¿›æ–‡æ¡£
- æäº¤ä»£ç ä¿®å¤æˆ–æ–°åŠŸèƒ½
- æ·»åŠ æµ‹è¯•ç”¨ä¾‹
- åˆ†äº«ä½¿ç”¨ç»éªŒ

è¯·éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. Forké¡¹ç›®
2. åˆ›å»ºæ‚¨çš„ç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/amazing-feature`)
3. æäº¤æ‚¨çš„æ›´æ”¹ (`git commit -m 'Add some amazing feature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/amazing-feature`)
5. å¼€å¯ä¸€ä¸ªPull Request

## ğŸ“„ è®¸å¯è¯

æ­¤é¡¹ç›®åŸºäº MIT è®¸å¯è¯ - è¯¦æƒ…è¯·æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## ğŸ‘¥ ç»´æŠ¤è€…

- [Dormoron](https://github.com/dormoron)

---

*å»ºè®¾æ›´å¯é ã€é«˜æ•ˆçš„å¾®æœåŠ¡æ¶æ„*